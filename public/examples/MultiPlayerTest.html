<!DOCTYPE html>
<html lang="en">
<head>
    <title></title>
    
    <script type="text/javascript" src="/nowjs/now.js"></script>
    <script type="text/javascript" src="..\tccore\jquery.min.js"></script>    
    <script type="text/javascript" src="..\tccore\NotConstants.js"></script>
    <script type="text/javascript" src="..\tccore\browserdetect.js"></script>
    <script type="text/javascript" src="..\tccore\GameEvent.js"></script>
    <script type="text/javascript" src="..\tccore\Frame.js"></script>
    <script type="text/javascript" src="..\tccore\Sprite.js"></script>
    <script type="text/javascript" src="..\tccore\BGSprite.js"></script>
    <script type="text/javascript" src="..\tccore\SpriteInventory.js"></script>
    <script type="text/javascript" src="..\tccore\GameWorld.js"></script>
    <script type="text/javascript" src="..\tccore\GameWorldModel2D.js"></script>
    <script type="text/javascript" src="..\tccore\GameWorldModelIso.js"></script>
    <script type="text/javascript" src="..\tccore\LoadShim.js"></script>
    <script type="text/javascript" src="..\tccore\Loader.js"></script>
    <script type="text/javascript" src="..\tccore\Engine.js"></script>
    <script type="text/javascript" src="..\assets\hero\hero.js"></script>
    <script type="text/javascript" src="..\assets\zombie\zombie.js"></script>
    <script type="text/javascript" src="..\assets\Cells\Cells.js"></script>
    <script type="text/javascript" src="..\assets\Cells\singleColumn.js"></script>
    <script type="text/javascript" src="..\tccore\pathfinding\BinaryHeap.js"></script>
    <script type="text/javascript" src="..\tccore\pathfinding\astar.js"></script>    
    <script type="text/javascript" src="..\tccore\Vector.js"></script>
    <script type="text/javascript" src="..\tccore\behaviors\Seeker.js"></script>
    <script type="text/javascript" src="..\tccore\behaviors\SpriteSeeker.js"></script>
    <script type="text/javascript" src="..\tccore\behaviors\OriginSeeker.js"></script>
    <script type="text/javascript" src="..\tccore\RepeatingAction.js"></script>
    <script type="text/javascript" src="..\tccore\requestMessages.js"></script>
    
    <meta content="width=320, user-scalable=0" />
    <meta http-equiv="pragma" content="no-cache"/>
    <meta name="viewport" content="user-scalable=no, width=device-width, initial-scale=1.0, maximum-scale=1.0" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black" />    
    <style>
    		table {border-collapse: collapse; text-align: center; vertical-align: middle;}
    		td {font-size: 8px; line-height: 10px; padding: 0; margin: 0;}
    		td div {width: 16px; height: 13px; overflow: hidden; padding-top:3px;}
    		td.door			{background-color:#acf;}
    		td.space		{background-color:#eee;}
    		td.camera		{background-color:yellow;}
    		td.stair		{background-color:#f70; color:#fff;}
    		td.empty		{background-color:#000; color:#aaa;}
    </style>
    <script type="text/javascript">

        var ga;
        var hero;
        var worldCells;
        var column;
        var zom;
        var zom2;      
        var gameWorld;
        var cave; 
        var colArray = [];
        var worldData;
        var documentReady = false;
        var moveQueue = [];
        $(document).ready(function () {
            ga = new Engine(document.getElementById("gamescreen"), document.getElementById("backbuffer2"));            
            now.receiveMessage = receiveMessage;
            documentReady = true
        });



        now.ready(function () {
		var id = setInterval(function(){
			//wait for document.ready
			if (!documentReady) return;
			clearInterval(id);
			
			//get something from the user in terms of name
			var name = prompt("got a name?");
			var initMsg = initRequestMsg(name);
			now.distributeMessage(JSON.stringify(initMsg));           	    
			
			//wire up click events
			ga.addEventBehavior(ga.gameEvents.MouseDown, undefined, undefined, undefined, handleClicks, 1);
			ga.setGameLoopHook(gameLoopHook);
		},300);
        });

        function addSprite(msg, ga) {
            //create sprite
            console.log("adding: " + msg.name);
            var inSprite = msg;
            if (inSprite.compositeDef == undefined && inSprite.spriteId == undefined) {
                //this is bad -
                throw "Sprites need to be a composite or a have a templateid - sorry bub.";

            }
            
            if (inSprite.compositeDef != undefined) {
            
                var hero;
                createCompositSprite(ga, inSprite.compositeDef, function (val) {
                    console.log("added: " + val.name);
                    hero = val;
                    hero.setSpeed(6);
                    //hero.boxSprite("#f00");
                    hero.setInnerDrawRectOverride(80, 100);
                    if (inSprite.x == undefined) {
                        throw "Why no x-pos man?";
                    }
                    else {
                        hero.setAtIsoPoint({ "x": inSprite.x, "y": inSprite.y }, false);
                    }
                    ga.defineSprite(hero);
                });
                return;
            }

            

            var template = TCSpriteInventory[inSprite.spriteId];
            var sprite = TCSpriteFactory(template, inSprite.name, ga, function (completeSprite) {
                //place sprite in cell               
                completeSprite.setSpeed(10);
                if (inSprite.x == undefined) {
                    gameWorldModel.placeSpriteInCenterOfWorldCell(inSprite.cellX, inSprite.cellY, completeSprite);
                }
                else {
                    completeSprite.setAtIsoPoint({ "x": inSprite.x, "y": inSprite.y }, false);
                }
                ga.defineSprite(completeSprite);
            });
        }

        function getRand(max) {
            return Math.floor(Math.random() * max);
        }
        
	function gameLoopHook()
	{
		var msg = moveQueue.shift();
		if (msg == undefined) return;
		if (msg.type == "move")
		{
			
			var sprite = ga.getSprite(msg.name);
			sprite.setSpriteState("WL");		    
			sprite.setAtIsoPoint({ "x": msg.x, "y": msg.y });
		}
		else
		{
			var sprite = ga.getSprite(msg.name);
		    	sprite.setSpriteState("NU");		    
		}

	}

	function updateCamera(camerax, cameray)
	{
		
		return;mov
		if (camerax == this.lastX && cameray== this.lastY)
		{
			return; //no update needed.
		}
	
		try{
			var cell = worldData[this.lastY][this.lastX];
		}
		catch(e)
		{
			console.log("break");
		}
		
		var theClass = "";
		
		if (cell < 1)	theClass = "empty";
		else if	(cell < 10) theClass = "space";
		else if	(cell < 20)	theClass = "door";
		else if (cell < 30)	theClass = "stair";
		
		this.lastX = camerax;
        	this.lastY = cameray;
		
		
		//invert camerax
		var wtf = worldData[cameray];
		
		
							
		
		$('#dungeon tr:eq(' + cameray + ') td:eq(' + camerax + ')').addClass("camera");
		$('#dungeon tr:eq(' + this.lastX + ') td:eq(' + this.lastY  + ')').removeClass("camera");
		$('#dungeon tr:eq(' + this.lastX + ') td:eq(' + this.lastY  + ')').addClass(theClass);
		
		
		
		
	}

        function makeMapTable(grid, camerax, cameray)
        {
		
			        	                
        	var tableHTML = "";
		for (r in grid) {
			r = parseInt(r);
			var row = grid[r];

			var tableRow = "";
			for (c in row) {
				c = parseInt(c);
				var cell = row[c];

				var theClass = "";
				if		(cell < 1)	theClass = "empty";
				else if	(cell < 10) theClass = "space";
				else if	(cell < 20)	theClass = "door";
				else if (cell < 30)	theClass = "stair";
				
				//center cell is overridden
				if (c==cameray && r==camerax) theClass = "camera";
				var title = {
					0:	"nothing",
					1:	"space",

					10:	"archway",
					11:	"door",
					12:	"locked door",
					13:	"trapped door",
					14:	"secret door",
					15:	"porticullis",

					21:	"stair down",
					22:	"stair up"

				}[cell];

				tableRow += "<td class=\""+theClass+"\" title=\""+title+"\"><div>"+cell+"</div></td>";
			}
			tableHTML += "<tr>"+tableRow+"</tr>";
		}
		document.getElementById('dungeon').innerHTML = tableHTML;
		
		this.lastX = camerax;
        	this.lastY = cameray;
        	
        }
        
        
        function receiveMessage (msg) {
		
		if (msg.type == "init") {
		    worldData = msg.world.worldArray;
		    gameWorld = new GameWorld(worldData.length, worldData[0].length, 73, 73, GAME_WORLD_STYLE_ISOMETRIC);
		    worldCells = altarCells_Sprite(ga);
		    worldCells.setup(ga);
		    column = shortColumnCell_Sprite(ga, "column");
		    cave = caveCells_Sprite(ga);
		    var worldWidth = worldData.length;
		    var worldHeight = worldData[0].length;
		    var cameraX = Math.floor(worldWidth/2);
		    var cameraY = Math.floor(worldHeight/2);		    

		    for (var i = 0; i < worldHeight ; i++) {
			for (var ii = 0; ii < worldWidth; ii++) {

			    if (worldData[i][ii] == 0) //todo: take into account doors, cooridors etc
			    {
				//set a cell using the worldCells sprite, randomly select one of the 25 frames in this sprite.
				//gameWorld_setCell(gameWorld, i, ii, worldCells, getRand(5), GAME_WORLD_CELL_UNDERLAY, GAME_WORLD_CELL_OPEN);
				var val = getRand(6);

				if (true)
				{
					var col = new BGSprite("column"+i + ii, column, 0, 0, 160, 352);
					gameWorld_setCell(gameWorld, i, ii, col, 0, GAME_WORLD_CELL_OVERLAY, GAME_WORLD_CELL_BLOCK);
				}
				else
				{
					gameWorld_setCell(gameWorld, i, ii, cave, 0, GAME_WORLD_CELL_UNDERLAY, GAME_WORLD_CELL_BLOCK);
				}


			    }
			    else //if (worldData[i][ii] == 1)
			    {

				//make a sprite that doesn't use up a bunch of memory
				gameWorld_setCell(gameWorld, i, ii, worldCells, 0, GAME_WORLD_CELL_UNDERLAY, GAME_WORLD_CELL_OPEN);

			    }

			}
		    }

		    ga.setWorld(gameWorld);

		   			
		    addSprite(msg.player, ga);
		    ga.setCamera(msg.player.cellX, msg.player.cellY);
		    cameraX = msg.player.cellX;		    
		    cameraY = msg.player.cellY;
		    makeMapTable(worldData, cameraX, cameraY);
		    for (var sprite in msg.objects) {
			//sprite = msg.world.objects[sprite];
			//addSprite(sprite, ga);
		    }

		    for (var sprite in msg.players) {
			//sprite = msg.world.players[sprite];
			//addSprite(sprite, ga);
		    }

		    var intervalid = setInterval(function () {
			if (worldCells.isLoadComplete() && column.isLoadComplete()) {
			    ga.play();
			    ga.wireArrowScan(function(){
				var cell = gameWorldModel.getWorldCellFromScreenCoord(ga.getCanvasWidth()/2, ga.getCanvasHeight()/2);
				updateCamera(cell.x,cell.y);


			    });
			    clearInterval(intervalid);
			}
		    });
		    		
		}

		//add a sprite
		if (msg.type == "add") {
		    	addSprite(msg, ga);
		}
		
		//remove a sprite
		if (msg.type == "rem") {
		    ga.removeSprite(msg.name);
		}

		//move a sprite
		if (msg.type == "move") {
		    if (msg.x == undefined)
		    {
		    	console.debug("Move has undefined position.");
		    }
		    moveQueue.push(msg);
		}

		//change a sprite
		if (msg.type == "chg") {
		    moveQueue.push(msg);		    
		}
            };
            
            function handleClicks(e)
            {            
		var spriteClick = ga.CheckEventPosition(e.offsetX, e.offsetY);
		//if we clicked a sprite, hightlight it
		if (spriteClick != undefined) {
		    if (this.lastClick != undefined) {
			this.lastClick.unHighLight();
		    }
		    this.lastClick = spriteClick;
		    spriteClick.highLight(0, 0, 0, 0, 255, 0, 0, 0);
		}
		else //if we have a sprite selected, move it.
		{
		    if (this.lastClick != undefined) {
			var msg = moveRequestMsg(this.lastClick.name, e.offsetX, e.offsetY, gameWorldModel.originX, gameWorldModel.originY);						
			now.distributeMessage(JSON.stringify(msg));
		    }
		}
		
            }
        
    </script>
</head>
<body>

//todo: fix allow move

    <canvas id="gamescreen" width="800" height="600" style="border-style: dotted; float: left;">
        No supporty canvisimo!
    </canvas>
    <canvas id="backbuffer2" width="800" height="600" style="visibility:hidden; display:none;"></canvas>    
    <div id="frameDebug"></div>
	<table id="dungeon">
	</table> 
    
    
</body>
</html>
